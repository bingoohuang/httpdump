<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="utf-8">
    <title>HTTP Dump</title>
    <link rel="stylesheet" type="text/css" href="bulma.min.css">
    <style>
        pre {
            white-space: pre-wrap; /* Since CSS 2.1 */
            white-space: -moz-pre-wrap; /* Mozilla, since 1999 */
            white-space: -o-pre-wrap; /* Opera 7 */
            word-wrap: break-word; /* Internet Explorer 5.5+ */
        }
    </style>
</head>

<body>
<!-- https://bulma.io/documentation/elements/table/ -->
<table class="table">
    <thead>
    <tr>
        <th title="Sequence">#</th>
        <th>Connection</th>
        <th>Method</th>
        <th>Host</th>
        <th>Path</th>
        <th>Content Type</th>
        <th>Status</th>
        <th>Time</th>
        <th>Req Size</th>
        <th>Rsp Size</th>
        <th style="display:none;">ReqPayload</th>
        <th style="display:none;">RspPayload</th>
        <th style="display:none;">ReqTimestamp</th>
        <th style="display:none;">RspTimestamp</th>
    </tr>
    </thead>
    <tbody id="tbody">
    </tbody>
</table>

<div class="modal" id="payloadModal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Details</p>
            <button class="delete" aria-label="close"></button>
        </header>
        <section class="modal-card-body" id="reqPayload">
        </section>
        <section class="modal-card-body" id="rspPayload">
        </section>
    </div>
</div>

<script type="text/javascript">
    var lastSelectedTr = null

    function showPayload(id) {
        let tr = document.getElementById(id)
        if (lastSelectedTr) {
            lastSelectedTr.classList.remove('is-selected')
            lastSelectedTr = null
        }
        tr.classList.add('is-selected');
        lastSelectedTr = tr
        document.getElementById("reqPayload").innerHTML = tr.cells[10].innerHTML
        document.getElementById("rspPayload").innerHTML = tr.cells[11].innerHTML
        openModal()
    }

    const source = new EventSource("sse");
    source.onmessage = function (e) {
        let j = JSON.parse(e.data)
        if (j.EOF) {
            return
        }

        let id = j.Connection + '.' + j.Seq
        if (j.Req) {
            let tr = document.getElementById("tbody").insertRow(0);
            tr.id = id
            tr.innerHTML =
                /* 0 */'<td><a href="javascript:showPayload(\'' + id + '\')">' + j.Seq + "</a></td>" +
                /* 1 */"<td>" + j.Connection + "</td>" +
                /* 2 */"<td>" + j.Method + "</td>" +
                /* 3 */"<td>" + j.Host + "</td>" +
                /* 4 */"<td>" + j.Path + "</td>" +
                /* 5 */"<td>" + j.ContentType + "</td>" +
                /* 6 */"<td>" + j.Status + "</td>" +
                /* 7 Time */"<td></td>" +
                /* 8 */"<td>" + j.ReqSize + "</td>" +
                /* 9 */"<td>" + j.RspSize + "</td>" +
                /* 10 */'<th style="display:none;"><pre>' + j.Payload + '</pre></th>' +
                /* 11 */'<th style="display:none;">><pre></pre></th>' +
                /* 12 */'<th style="display:none;">' + j.Timestamp + '</th>' +
                /* 13 */'<th style="display:none;"></th>'
        } else if (j.Rsp) {
            let tr = document.getElementById(id);
            if (tr) {
                tr.cells[5].innerText = j.ContentType
                tr.cells[6].innerText = j.Status
                tr.cells[7].innerText = (Date.parse(j.Timestamp) - Date.parse(tr.cells[12].innerText)) + ' ms'
                tr.cells[9].innerText = j.RspSize
                tr.cells[11].innerHTML = '<pre>' + j.Payload + '</pre>'
                tr.cells[13].innerText = j.Timestamp
            }
        }
    };
    source.onerror = function (err) {
        console.warn(err)
    };
    source.onclose = function (err) {
        console.info("closed", err)
    };

    const payloadModal = document.getElementById('payloadModal')

    // Functions to open and close a modal
    function openModal() {
        payloadModal.classList.add('is-active');
    }

    function closeModal() {
        payloadModal.classList.remove('is-active');
    }


    document.addEventListener('DOMContentLoaded', () => {
        // Add a click event on various child elements to close the parent modal
        (document.querySelectorAll('.modal-background, .modal-close, .modal-card-head .delete, .modal-card-foot .button') || []).forEach(($close) => {
            $close.addEventListener('click', closeModal);
        });

        // Add a keyboard event to close all modals
        document.addEventListener('keydown', (event) => {
            const e = event || window.event;

            if (e.keyCode === 27) { // Escape key
                closeModal()
            }
        });
    });
</script>
</body>
</html>